{% import '@Marketplace/macros.twig' as marketplaceMacro %}

{% block content %}

    <div class="pluginDetails">
        {% if errorMessage %}
            {{ errorMessage }}
        {% elseif plugin %}

            {% if plugin.versions is not empty and plugin.versions[plugin.versions|length - 1] %}
                {% set latestVersion = plugin.versions[plugin.versions|length - 1] %}
            {% else %}
                {% set latestVersion = '' %}
            {% endif %}

            <div class="header">
                <div class="intro" style="width:75%;float:left;">
                    <h2>{{ plugin.name }}</h2>
                    <p class="description">
                        {% if plugin.featured %}
                            {{ marketplaceMacro.featuredIcon('left') }}
                        {% endif %}
                        {{ plugin.description }}
                    </p>
                </div>
                <div class="width:25%;float:left;">
                    {% if not plugin.isDownloadable or not isSuperUser %}
                        <a class="install update" target="_blank"
                           href="{{ plugin.homepage|e('html_attr') }}"
                        >{{ 'General_MoreDetails'|translate }}</a>
                    {% elseif isSuperUser %}
                        {% if not isAutoUpdatePossible %}
                            <a onclick="$(this).css('display', 'none')" href="{{ linkTo({'action': 'download', 'pluginName': plugin.name, 'nonce': (plugin.name|nonce)}) }}"
                               class="download">{{ 'General_Download'|translate }}</a>
                        {% elseif plugin.canBeUpdated and 0 == plugin.missingRequirements|length %}
                            <a class="install update"
                               href="{{ linkTo({'module': 'Marketplace', 'action':'updatePlugin', 'pluginName': plugin.name, 'nonce': updateNonce}) }}"
                                    >{{ 'CoreUpdater_UpdateTitle'|translate }}</a>
                        {% elseif plugin.isInstalled %}
                        {% elseif 0 < plugin.missingRequirements|length %}
                        {% else %}
                            <a href="{{ linkTo({'module': 'Marketplace', 'action': 'installPlugin', 'pluginName': plugin.name, 'nonce': installNonce}) }}"
                               class="install">{{ 'Marketplace_ActionInstall'|translate }}</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <div class="content">
                <div style="width:75%;float:left;">

                    <div id="pluginDetailsTabs">
                        <ul>
                            <li><a href="#tabs-description">{{ 'General_Description'|translate }}</a></li>
                            {% if latestVersion.readmeHtml.faq %}
                                <li><a href="#tabs-faq">{{ 'General_Faq'|translate }}</a></li>
                            {% endif %}
                            {% if plugin.isDownloadable %}
                                <li><a href="#tabs-changelog">{{ 'CorePluginsAdmin_Changelog'|translate }}</a></li>
                            {% endif %}
                            {% if plugin.screenshots|length %}
                                <li><a href="#tabs-screenshots">{{ 'Marketplace_Screenshots'|translate }}</a></li>
                            {% endif %}
                            {% if latestVersion.readmeHtml.support %}
                                <li><a href="#tabs-support">{{ 'Marketplace_Support'|translate }}</a></li>
                            {% endif %}
                        </ul>

                        <div id="tabs-description">
                            {% if isSuperUser and plugin.isDownloadable %}
                                {{ marketplaceMacro.missingRequirementsPleaseUpdateNotice(plugin) }}

                                {% if isMultiServerEnvironment %}
                                    <div class="alert alert-warning">{{ 'Marketplace_MultiServerEnvironmentWarning'|translate }}</div>
                                {% elseif not isAutoUpdateEnabled %}
                                    <div class="alert alert-warning">{{ 'Marketplace_AutoUpdateDisabledWarning'|translate("'[General]enable_auto_updates=1'", "'config/config.ini.php'") }}</div>
                                {% endif %}
                            {% endif %}

                            {{ latestVersion.readmeHtml.description|raw }}
                        </div>

                        {% if latestVersion.readmeHtml.faq %}
                            <div id="tabs-faq">
                                {{ latestVersion.readmeHtml.faq|raw }}
                            </div>
                        {% endif %}

                        {% if plugin.isDownloadable %}
                            <div id="tabs-changelog">
                                {{ marketplaceMacro.missingRequirementsPleaseUpdateNotice(plugin) }}
                                {% if plugin.canBeUpdated %}
                                    <div class="alert alert-warning">
                                        {{ 'Marketplace_PluginUpdateAvailable'|translate(plugin.currentVersion, plugin.latestVersion) }}
                                        {% if plugin.repositoryChangelogUrl %}<a rel="noreferrer"  target="_blank" href="{{ plugin.repositoryChangelogUrl }}">{{ 'Marketplace_ViewRepositoryChangelog'|translate }}</a>{% endif %}
                                    </div>
                                {% endif %}

                                {% if latestVersion.readmeHtml.changelog %}
                                    {{ latestVersion.readmeHtml.changelog|raw }}
                                {% endif %}

                                <h3>{{ 'CorePluginsAdmin_History'|translate }}</h3>

                                <ul>
                                    {% for version in plugin.versions|reverse %}
                                        <li>
                                            {% set versionName %}
                                                <strong>
                                                    {% if version.repositoryChangelogUrl %}
                                                        <a target="_blank" title="{{ 'CorePluginsAdmin_Changelog'|translate }}" href="{{ version.repositoryChangelogUrl }}">{{ version.name }}</a>
                                                    {% else %}
                                                        {{ version.name }}
                                                    {% endif %}
                                                </strong>
                                            {% endset %}
                                            {{ 'Marketplace_PluginVersionInfo'|translate(versionName, version.release)|raw }}
                                            </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        {% if plugin.screenshots|length %}
                            <div id="tabs-screenshots">
                                <div class="thumbnails">
                                    {% for screenshot in plugin.screenshots %}
                                        <div class="thumbnail">
                                            <a href="{{ screenshot }}" target="_blank"><img src="{{ screenshot }}?w=400" width="400" alt=""></a>
                                            <p>
                                                {{ screenshot|split('/')|last|replace({'_': ' ', '.png': '', '.jpg': '', '.jpeg': ''}) }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if latestVersion.readmeHtml.support %}
                            <div id="tabs-support">

                                {{ latestVersion.readmeHtml.support|raw }}

                            </div>
                        {% endif %}
                    </div>

                </div>
                <div class="metadata" style="width:25%;float:left;">
                    <p><br /></p>
                    <dl>
                        <dt>{{ 'CorePluginsAdmin_Version'|translate }}</dt>
                        <dd>{{ plugin.latestVersion }}</dd>
                        <dt>{{ 'Marketplace_PluginKeywords'|translate }}</dt>
                        <dd>{{ plugin.keywords|join(', ') }}</dd>
                        {% if plugin.lastUpdated %}
                            <dt>{{ 'Marketplace_LastUpdated'|translate }}</dt>
                            <dd>{{ plugin.lastUpdated }}</dd>
                        {% endif %}
                        {% if plugin.numDownloads %}
                            <dt>{{ 'General_Downloads'|translate }}</dt>
                            <dd title="{{ 'Marketplace_NumDownloadsLatestVersion'|translate(latestVersion.numDownloads|number_format) }}">{{ plugin.numDownloads }}</dd>
                        {% endif %}
                        <dt>{{ 'Marketplace_Developer'|translate }}</dt>
                        <dd>{{ marketplaceMacro.pluginDeveloper(plugin.owner) }}</dd>
                        <dt>{{ 'Marketplace_Authors'|translate }}</dt>
                        <dd>{% for author in plugin.authors if author.name %}

                                {% spaceless %}
                                    {% if author.homepage %}
                                        <a target="_blank" href="{{ author.homepage }}">{{ author.name }}</a>
                                    {% elseif author.email %}
                                        <a href="mailto:{{ author.email|escape('url') }}">{{ author.name }}</a>
                                    {% else %}
                                        {{ author.name }}
                                    {% endif %}

                                    {% if loop.index < plugin.authors|length %}
                                        ,
                                    {% endif %}
                                {% endspaceless %}

                            {% endfor %}
                        </dd>
                        <dt>{{ 'CorePluginsAdmin_Websites'|translate }}</dt>
                        <dd>
                            {% if plugin.homepage %}
                                <a target="_blank" href="{{ plugin.homepage }}">{{ 'Marketplace_PluginWebsite'|translate }}</a>,
                            {% endif %}
                            <a target="_blank" href="{{ plugin.repositoryUrl }}">GitHub</a></dd>
                        {% if plugin.activity and plugin.activity.numCommits %}
                            <dt>{{ 'CorePluginsAdmin_Activity'|translate }}</dt>
                            <dd>
                                {{ plugin.activity.numCommits }} commits

                                {% if plugin.activity.numContributors > 1 %}
                                    {{ 'Marketplace_ByXDevelopers'|translate(plugin.activity.numContributors) }}
                                {% endif %}
                                {% if plugin.activity.lastCommitDate %}
                                    {{ 'Marketplace_LastCommitTime'|translate(plugin.activity.lastCommitDate) }}
                                {% endif %}</dd>
                        {% endif %}
                    </dl>
                    <br />
                </div>
            </div>
            <script type="text/javascript">
                $(function() {

                    var active = 0;
                    {% if activeTab %}
                        var $activeTab = $('#tabs-{{ activeTab|e('js') }}');
                        if ($activeTab) {
                            active = $activeTab.index() - 1;
                        }
                    {% endif %}

                    $( "#pluginDetailsTabs" ).tabs({active: active >= 0 ? active : 0});

                    $('.pluginDetails a').each(function (index, a) {
                        var link = $(a).attr('href');

                        if (link && 0 === link.indexOf('http')) {
                            $(a).attr('target', '_blank');
                        }
                    });
                });
            </script>
        {% endif %}
    </div>

{% endblock %}
